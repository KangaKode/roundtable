# {{ project_name }} Agent Guide

> This is the entry point for AI agents working on the {{ project_name }} codebase.
> Follow progressive disclosure: read this file first, then drill into linked docs as needed.
> Do NOT load everything at once -- context is a scarce resource.

---

## Architecture

{{ project_description }}

**Canonical architecture doc:** [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md)

### Layering Rules (enforced by lint)

```
{% set layer_list = layers.split(',') -%}
{% for layer in layer_list -%}
{{ layer | trim }}/ {% if loop.first %}(bottom layer -- NEVER imports from layers above){% elif loop.last %}(top layer -- can import from layers below){% else %}(middle layer -- imports only from layers below){% endif %}
{% endfor -%}
```

Additional modules (not in the layer stack):
- `llm/` -- Isolated LLM client (no cross-imports)
- `security/` -- Prompt guard, validators (imported by any layer)
{% if include_api_gateway -%}
- `api/` -- FastAPI gateway (imports from all layers)
{% endif -%}
{% if include_learning -%}
- `learning/` -- Feedback, trust, preferences, RAG (imports from security/)
{% endif -%}

Violation of these rules will be caught by `tests/test_architecture.py`.

---

## Coding Standards

- Architecture-first: NO CODE WITHOUT ARCHITECTURE REVIEW
- Always provide complete code, never placeholders
- Break problems into smaller steps
- Add logging for debugging (`logger.debug(f"[ComponentName] message")`)
- Keep files under 500 lines
- Use dataclasses for domain models, parse at boundaries
- Security: sanitize all external input, parameterized SQL, validate URLs
{% if persistence == 'sqlite' -%}
- All data persists to SQLite; session state is for UI convenience only
{% elif persistence == 'postgres' -%}
- All data persists to PostgreSQL; session state is for UI convenience only
{% endif -%}

**Full standards:** [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md)

---

## Core Systems

> **Quick start:** Run `make demo` to see the round table protocol in action with mock agents (no API keys needed). For a guided walkthrough, see [docs/TUTORIAL.md](docs/TUTORIAL.md).

### LLM Client (Importance: 95/100)
Provider-agnostic wrapper with automatic prompt caching. Use `CacheablePrompt` to separate stable prefix from dynamic content for token savings.
**Key files:** `llm/client.py`

### Round Table (Importance: 90/100)
Full 4-phase multi-agent deliberation: Strategy, Independent Analysis, Challenge, Synthesis + Voting. For complex decisions needing all perspectives.
**Key files:** `orchestration/round_table.py`

### Chat Orchestrator (Importance: 90/100)
Lightweight orchestrator-worker pattern. Lead agent selects 1-3 specialists, cross-checks responses, surfaces disagreements, escalates to round table when needed.
**Key files:** `orchestration/chat_orchestrator.py`, `orchestration/agent_router.py`

### Agent System (Importance: 85/100)
Local agents implement `AgentProtocol`. Remote agents (any language) connect over HTTP via `RemoteAgent` adapter. `AgentRegistry` manages all agents.
**Key files:** `agents/example_agent.py`, `agents/remote.py`, `agents/registry.py`

{% if include_api_gateway -%}
### API Gateway (Importance: 85/100)
FastAPI server with 10 route modules. Auth middleware (API key), rate limiting, CORS. SSE streaming for chat.
**Key files:** `api/gateway.py`, `api/routes/`
{% endif -%}

### Security (Importance: 95/100)
Prompt injection defense, SSRF protection, input validation, rate limiting, HMAC webhooks. Security is wired into every module, not bolted on.
**Key files:** `security/prompt_guard.py`, `security/validators.py`

{% if include_learning -%}
### Learning System (Importance: 80/100)
Feedback tracking, agent trust scores (EMA), check-in manager (never adapts silently), user profile synthesis, RAG preference retrieval, cross-project graduation.
**Key files:** `learning/feedback_tracker.py`, `learning/agent_trust.py`, `learning/checkin_manager.py`, `learning/user_profile.py`
{% endif -%}

### Session Lifecycle (Importance: 75/100)
Item/Turn/Thread model with Initializer/Worker pattern. Startup ritual loads state; cleanup ritual persists progress.
**Key files:** `harness/session.py`

---

## Testing

- Framework: pytest with markers (P0, P1, smoke, slow)
- Architecture tests: `tests/test_architecture.py` enforces layering rules
{% if include_evals -%}
- Evals: `evals/` directory for capability and regression evals
{% endif -%}
- Pre-commit: Black, Ruff, Bandit
- Red team: `scripts/red_team_check.py` blocks commits with security findings

**Standards:** [docs/TESTING_STANDARDS.md](docs/TESTING_STANDARDS.md)

---

## Current Work

<!-- Update this section as the project progresses -->

**Quality scores:** [docs/QUALITY_SCORE.md](docs/QUALITY_SCORE.md)
**References:** [docs/REFERENCES.md](docs/REFERENCES.md)

---

## Doc Registry

| Category | Location | Description |
|----------|----------|-------------|
| Tutorial | `docs/TUTORIAL.md` | Your First Agent in 30 Minutes (start here) |
| Architecture | `docs/ARCHITECTURE.md` | Layering rules, dependency directions, core systems |
| Testing | `docs/TESTING_STANDARDS.md` | Testing conventions |
| Quality | `docs/QUALITY_SCORE.md` | Per-domain quality grades |
| References | `docs/REFERENCES.md` | Industry research and key principles |
| Eval Scaling | `docs/EVAL_SCALING_GUIDE.md` | Scaling evals, graduation pattern |
| Glossary | `docs/GLOSSARY.md` | 25 AI/agent terms for non-experts |
| Team Overview | `docs/TEAM_OVERVIEW.md` | 5-min stakeholder read: what, how, why, safety |
| Platform Guide | `docs/PLATFORM_GUIDE.md` | Multi-tenant: RBAC, agent isolation, team onboarding |
| Agent Protocol | `docs/AGENT_PROTOCOL.md` | External agent HTTP contract: JSON schemas, examples |

**Full index:** [docs/INDEX.md](docs/INDEX.md)
