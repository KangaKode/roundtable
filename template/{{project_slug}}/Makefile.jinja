# {{ project_name }} Development Commands
# Run 'make help' to see all available targets.

.PHONY: help test test-p0 test-p1 test-arch test-all lint format red-team doctor clean

help: ## Show this help message
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# =============================================================================
# TESTING
# =============================================================================

test: ## Run all tests
	python -m pytest tests/ -v --tb=short

test-unit: ## Run unit tests only (no API/E2E)
	python -m pytest tests/test_security.py tests/test_llm.py tests/test_learning.py tests/test_agents.py tests/test_orchestration.py -v --tb=short

{% if include_api_gateway -%}
test-api: ## Run API integration tests
	python -m pytest tests/test_api.py -v --tb=short

test-e2e: ## Run end-to-end tests
	python -m pytest tests/test_e2e.py -v --tb=short
{% endif %}

test-p0: ## Run P0 critical tests only
	python -m pytest tests/ -m "p0" -v --tb=short

test-p1: ## Run P1 important tests
	python -m pytest tests/ -m "p1" -v --tb=short

test-arch: ## Run architecture enforcement tests
	python -m pytest tests/test_architecture.py -v --tb=short

test-all: ## Run ALL tests with coverage
	python -m pytest tests/ --cov --cov-report=term-missing -v

# =============================================================================
# CODE QUALITY
# =============================================================================

lint: ## Run all linters
	ruff check .
{% set layer_list = layers.split(',') | map('trim') | list -%}
	bandit -r {% for layer in layer_list %}{{ layer }}/{% if not loop.last %} {% endif %}{% endfor %} -ll --quiet

format: ## Format code with Black
	black .

red-team: ## Run red team check on all source files
	python scripts/red_team_check.py $$(find {% for layer in layer_list %}{{ layer }}/{% if not loop.last %} {% endif %}{% endfor %} -name "*.py" -not -path "*/__pycache__/*")

red-team-staged: ## Run red team on staged files only
	python scripts/red_team_check.py

# =============================================================================
# EVALUATION
# =============================================================================

{% if include_evals -%}
eval: ## Run evaluation suite
	python -m pytest evals/ -v --tb=short

eval-regression: ## Run regression evals only
	python -m pytest evals/regression/ -v --tb=short
{% endif %}

# =============================================================================
# PROJECT HEALTH
# =============================================================================

doctor: ## Check project structure health
	@echo "=== Architecture Tests ==="
	python -m pytest tests/test_architecture.py -v --tb=short
	@echo ""
	@echo "=== Red Team Check ==="
	python scripts/red_team_check.py $$(find {% for layer in layer_list %}{{ layer }}/{% if not loop.last %} {% endif %}{% endfor %} -name "*.py" -not -path "*/__pycache__/*" 2>/dev/null | head -20) || true
	@echo ""
	@echo "=== Linters ==="
	ruff check . --statistics || true
	@echo ""
	@echo "=== Doc Freshness ==="
	python scripts/doc_freshness.py || true
	@echo ""
	@echo "Doctor complete."

scan: ## Full project scan (architecture + red team + linters + file sizes) -- use for continuous quality
	@echo "=== Architecture Enforcement ==="
	python -m pytest tests/test_architecture.py -v --tb=short || true
	@echo ""
	@echo "=== Red Team Security Scan ==="
{% set layer_list = layers.split(',') | map('trim') | list -%}
	python scripts/red_team_check.py $$(find src/ -name "*.py" -not -path "*/__pycache__/*" 2>/dev/null) || true
	@echo ""
	@echo "=== Lint ==="
	ruff check . --statistics || true
	@echo ""
	@echo "=== File Size Audit ==="
	@find src/ -name "*.py" -not -path "*/__pycache__/*" -exec wc -l {} + 2>/dev/null | sort -rn | head -15
	@echo ""
	@echo "Scan complete. Fix BLOCKING findings before committing."

demo: ## Run round table demo (no API keys needed)
	python scripts/demo.py

check: ## Verify environment setup
	python scripts/setup_check.py

new-agent: ## Create a new agent from template (NAME=my_analyst DOMAIN="code review")
	@test -n "$(NAME)" || (echo "Usage: make new-agent NAME=my_analyst DOMAIN=\"code review\"" && exit 1)
	@test -n "$(DOMAIN)" || (echo "Usage: make new-agent NAME=my_analyst DOMAIN=\"code review\"" && exit 1)
	$(eval AGENT_CLASS := $(shell python3 -c "print(''.join(w.capitalize() for w in '$(NAME)'.split('_')))"))
	@cp src/{{ project_slug }}/agents/example_agent.py src/{{ project_slug }}/agents/$(NAME).py
	@sed -i'' -e 's/ExampleAgent/$(AGENT_CLASS)/g' src/{{ project_slug }}/agents/$(NAME).py
	@sed -i'' -e 's/example_analyst/$(NAME)/g' src/{{ project_slug }}/agents/$(NAME).py
	@sed -i'' -e 's/general analysis/$(DOMAIN)/g' src/{{ project_slug }}/agents/$(NAME).py
	@echo "Created src/{{ project_slug }}/agents/$(NAME).py (class $(AGENT_CLASS))"
	@echo "Next: edit the analyze() method to add your domain logic"

install: ## Install dependencies
	pip install -r requirements.txt

{% if include_api_gateway -%}
# =============================================================================
# API GATEWAY
# =============================================================================

serve: ## Start the API gateway (development mode with auto-reload)
	uvicorn src.{{ project_slug }}.api.gateway:app --reload --host 0.0.0.0 --port 8000

serve-prod: ## Start the API gateway (production mode)
	uvicorn src.{{ project_slug }}.api.gateway:app --host 0.0.0.0 --port 8000 --workers 4
{% endif %}

{% if include_deployment -%}
# =============================================================================
# DOCKER
# =============================================================================

docker-build: ## Build Docker image
	docker build -t {{ project_slug }}:latest .

docker-run: ## Run with docker-compose
	docker-compose up

docker-run-d: ## Run with docker-compose (background)
	docker-compose up -d

docker-stop: ## Stop docker-compose services
	docker-compose down

docker-test: ## Run tests inside Docker container
	docker-compose run --rm app make test

docker-logs: ## Follow application logs
	docker-compose logs -f app

# =============================================================================
# KUBERNETES
# =============================================================================

k8s-deploy: ## Deploy to Kubernetes
	kubectl apply -f deploy/k8s/

k8s-status: ## Check deployment status
	kubectl get pods -l app={{ project_slug }}
	@echo ""
	kubectl get svc {{ project_slug }}

k8s-logs: ## Follow pod logs
	kubectl logs -f -l app={{ project_slug }}

k8s-delete: ## Remove from Kubernetes
	kubectl delete -f deploy/k8s/
{% endif %}

clean: ## Remove caches and generated files
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .ruff_cache -exec rm -rf {} + 2>/dev/null || true
	rm -rf .coverage htmlcov/ .aiscaffold/
	@echo "Cleaned."
