{% if include_api_gateway -%}
"""End-to-end tests exercising the full stack."""

import pytest
from httpx import AsyncClient, ASGITransport

from src.{{ project_slug }}.api.gateway import create_app
from src.{{ project_slug }}.agents.registry import AgentRegistry
from src.{{ project_slug }}.orchestration.round_table import RoundTableConfig


@pytest.fixture
async def e2e_client(mock_agents, mock_llm, tmp_path):
    """E2E client with pre-registered mock agents and LLM."""
    import os
    os.environ.pop("API_KEY", None)
    os.environ.pop("ENV", None)

    registry = AgentRegistry(persist_path=tmp_path / "e2e_agents.json")
    for agent in mock_agents:
        registry.register_local(agent, capabilities=["testing"])

    config = RoundTableConfig(
        enable_strategy_phase=False,
        enable_challenge_phase=False,
    )

    app = create_app(registry=registry, round_table_config=config)
    app.state.llm_client = mock_llm

    transport = ASGITransport(app=app)
    async with AsyncClient(transport=transport, base_url="http://test") as c:
        yield c


class TestE2ERoundTable:
    @pytest.mark.asyncio
    async def test_full_round_table_flow(self, e2e_client):
        """Submit task -> verify agents participated -> check result structure."""
        r = await e2e_client.post("/api/v1/round-table/tasks", json={
            "content": "Analyze the test scenario for quality",
        })
        assert r.status_code == 200
        data = r.json()
        assert data["status"] == "completed"
        assert len(data["analyses"]) == 2
        assert data["task_id"] is not None


class TestE2EChat:
    @pytest.mark.asyncio
    async def test_chat_with_agents(self, e2e_client):
        """Send message -> verify agents consulted."""
        r = await e2e_client.post("/api/v1/chat", json={
            "message": "What are the key considerations for testing?",
        })
        assert r.status_code == 200
        data = r.json()
        assert "content" in data
        assert len(data["content"]) > 0


class TestE2EFeedbackLoop:
    @pytest.mark.asyncio
    async def test_feedback_updates_trust(self, e2e_client):
        """Record feedback -> verify trust score changed."""
        r = await e2e_client.post("/api/v1/feedback", json={
            "signal_type": "accept",
            "agent_id": "analyst_a",
            "context_type": "chat",
        })
        assert r.status_code == 200

        rates = await e2e_client.get("/api/v1/feedback/rates")
        assert rates.status_code == 200


class TestE2ESessions:
    @pytest.mark.asyncio
    async def test_session_lifecycle(self, e2e_client):
        """Create session -> add turns -> verify count."""
        create_r = await e2e_client.post("/api/v1/sessions", json={})
        assert create_r.status_code == 200
        sid = create_r.json()["session_id"]

        turn_r = await e2e_client.post(f"/api/v1/sessions/{sid}/turns", json={
            "content": "First turn",
        })
        assert turn_r.status_code == 200
        assert turn_r.json()["turn_count"] == 1

        turn_r2 = await e2e_client.post(f"/api/v1/sessions/{sid}/turns", json={
            "content": "Second turn",
        })
        assert turn_r2.json()["turn_count"] == 2


class TestE2ESecurity:
    @pytest.mark.asyncio
    async def test_ssrf_blocked_on_registration(self, e2e_client):
        """Register agent with private URL -> verify SSRF blocked."""
        r = await e2e_client.post("/api/v1/agents", json={
            "name": "evil_agent",
            "domain": "testing",
            "base_url": "http://127.0.0.1:8080",
        })
        assert r.status_code == 400


{% else -%}
# E2E tests skipped: include_api_gateway is false
{% endif -%}
