# aiscaffold Validation Pipeline
# Runs on every push to main and every PR.
# Blocks merge on any failure.
#
# Three stages:
#   1. Quick checks (templates only, ~10s)
#   2. Matrix validation (3 template configs, ~2min)
#   3. Summary

name: Validate Scaffold

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: pip install jinja2

      - name: Run quick checks
        run: python3 scripts/quick_checks.py

  validate-matrix:
    name: Validate (${{ matrix.project_type }})
    runs-on: ubuntu-latest
    needs: quick-checks
    strategy:
      fail-fast: false
      matrix:
        include:
          - project_type: web-app
            llm_provider: anthropic
            persistence: sqlite
          - project_type: multi-agent
            llm_provider: openai
            persistence: postgres
          - project_type: api-service
            llm_provider: anthropic
            persistence: sqlite

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install tools
        run: |
          pip install copier ruff bandit jinja2

      - name: Run full validation
        run: |
          bash scripts/validate_generated.sh \
            "${{ matrix.project_type }}" \
            "${{ matrix.llm_provider }}" \
            "${{ matrix.persistence }}"

  summary:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [quick-checks, validate-matrix]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.quick-checks.result }}" != "success" ] || \
             [ "${{ needs.validate-matrix.result }}" != "success" ]; then
            echo "❌ Validation FAILED"
            echo "  quick-checks: ${{ needs.quick-checks.result }}"
            echo "  validate-matrix: ${{ needs.validate-matrix.result }}"
            exit 1
          fi
          echo "✅ All validations passed"
